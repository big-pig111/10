<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>64x64 图片网格上传</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.31.0/dist/umd/supabase.min.js"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#722ED1',
            accent: '#FF7D00',
            dark: '#1D2129',
            light: '#F2F3F5'
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .btn-primary {
        @apply bg-primary text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 hover:bg-primary/90 hover:shadow-md active:scale-95;
      }
    }
    #images-grid {
      overflow: auto;
      background: #fff;
    }
  </style>
</head>
<body class="font-inter bg-light min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <div class="w-10 h-10 rounded-lg bg-primary flex items-center justify-center">
          <i class="fa fa-image text-white text-xl"></i>
        </div>
        <h1 class="text-xl font-bold text-dark">64×64 图片网格上传</h1>
      </div>
      <button id="wallet-connect-btn" class="btn-primary ml-4">连接钱包</button>
    </div>
  </header>

  <!-- 主内容区 -->
  <main id="main-area" class="flex-grow flex flex-col items-center justify-center p-0 m-0 w-full h-full">
    <div id="images-grid" class="grid bg-white w-full h-full"></div>
  </main>

  <!-- 图片预览模态框 -->
  <div id="image-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
    <div class="relative max-w-4xl w-full mx-4">
      <button id="close-modal" class="absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors">
        <i class="fa fa-times text-2xl"></i>
      </button>
      <div class="bg-white rounded-lg overflow-hidden">
        <div class="relative" style="padding-bottom: 75%;">
          <img id="modal-image" src="" alt="图片预览" class="absolute inset-0 w-full h-full object-contain">
        </div>
        <div class="p-4 flex justify-between items-center">
          <div>
            <h3 id="modal-filename" class="font-medium text-dark"></h3>
            <p id="modal-created-at" class="text-sm text-gray-500"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 配置 Supabase
    const supabase = window.supabase.createClient(
      'https://varxwothzqvxzskyjrrn.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhcnh3b3RoenF2eHpza3lqcnJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3OTkwNTUsImV4cCI6MjA2NDM3NTA1NX0.N6DfiR5e_426cnFED3_KWJlY4chtqofeNy-QkA4OdLI'
    );
    const CELL_SIZE = 20; // 固定格子像素
    const COLS = 80; // 固定列数
    const ROWS = 40; // 固定行数
    const imagesGrid = document.getElementById('images-grid');

    // SPL代币冷却限制配置
    const TOKEN_MINT = 'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263';
    const COOLDOWN_HOLDER = 20; // 秒
    const COOLDOWN_NONHOLDER = 40; // 秒
    let lastUploadTime = 0;

    // 查询SPL代币余额
    async function getTokenBalance(userAddress) {
      const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com');
      const publicKey = new solanaWeb3.PublicKey(userAddress);
      const tokenMint = new solanaWeb3.PublicKey(TOKEN_MINT);
      const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
        publicKey,
        { mint: tokenMint }
      );
      let tokenAmount = 0;
      if (tokenAccounts.value.length > 0) {
        tokenAmount = tokenAccounts.value[0].account.data.parsed.info.tokenAmount.uiAmount;
      }
      return tokenAmount;
    }

    // 上传前判断
    async function canUpload(userAddress) {
      const tokenAmount = await getTokenBalance(userAddress);
      const cooldown = tokenAmount > 0 ? COOLDOWN_HOLDER : COOLDOWN_NONHOLDER;
      const now = Date.now();
      if (now - lastUploadTime < cooldown * 1000) {
        alert(`请等待${Math.ceil((cooldown*1000 - (now-lastUploadTime))/1000)}秒后再上传`);
        return false;
      }
      lastUploadTime = now;
      return true;
    }

    // 钱包连接按钮逻辑
    document.addEventListener('DOMContentLoaded', () => {
      const walletBtn = document.getElementById('wallet-connect-btn');
      function shortAddress(addr) {
        return addr ? addr.slice(0, 4) + '...' + addr.slice(-4) : '';
      }
      walletBtn.addEventListener('click', async () => {
        if (window.solana && window.solana.isPhantom) {
          try {
            const resp = await window.solana.connect();
            walletBtn.textContent = shortAddress(resp.publicKey.toString());
          } catch (e) {}
        } else {
          alert('请安装 Phantom 钱包');
          window.open('https://phantom.app/', '_blank');
        }
      });
    });

    // 固定网格数量，固定格子为20x20像素
    function renderGrid() {
      imagesGrid.innerHTML = '';
      imagesGrid.style.gridTemplateColumns = `repeat(${COLS}, ${CELL_SIZE}px)`;
      imagesGrid.style.gridTemplateRows = `repeat(${ROWS}, ${CELL_SIZE}px)`;
      imagesGrid.style.width = `${COLS * CELL_SIZE}px`;
      imagesGrid.style.height = `${ROWS * CELL_SIZE}px`;
      for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
          const cell = document.createElement('div');
          cell.className = `relative flex items-center justify-center bg-gray-50 overflow-hidden border border-gray-100`;
          cell.style.width = `${CELL_SIZE}px`;
          cell.style.height = `${CELL_SIZE}px`;
          cell.dataset.x = x;
          cell.dataset.y = y;
          cell.innerHTML = `
            <input type="file" accept="image/*" class="hidden" id="file-input-${x}-${y}">
            <label for="file-input-${x}-${y}" class="absolute inset-0 flex items-center justify-center cursor-pointer transition group">
              <span class="text-gray-400 text-lg z-10 group-hover:text-primary" id="upload-icon-${x}-${y}">
                <i class="fa fa-cloud-upload"></i>
              </span>
              <img id="img-${x}-${y}" class="absolute inset-0 w-full h-full object-cover hidden" draggable="false" />
            </label>
          `;
          imagesGrid.appendChild(cell);
          // 事件绑定
          const fileInput = cell.querySelector(`#file-input-${x}-${y}`);
          fileInput.addEventListener('change', (e) => handleCellUpload(e, x, y));
        }
      }
      // 自动加载所有格子的图片
      loadAllCellImages();
    }

    // 上传图片（无支付、无归属校验）
    async function handleCellUpload(event, x, y) {
      const file = event.target.files[0];
      if (!file) return;
      let userAddress = null;
      if (window.solana && window.solana.isPhantom && window.solana.isConnected && window.solana.publicKey) {
        userAddress = window.solana.publicKey.toString();
      }
      // 冷却判断
      if (userAddress) {
        if (!await canUpload(userAddress)) return;
      } else {
        // 未连接钱包，直接40秒冷却
        const now = Date.now();
        const cooldown = COOLDOWN_NONHOLDER;
        if (now - lastUploadTime < cooldown * 1000) {
          alert(`请等待${Math.ceil((cooldown*1000 - (now-lastUploadTime))/1000)}秒后再上传`);
          return;
        }
        lastUploadTime = now;
      }
      const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
      if (!allowedTypes.includes(file.type)) {
        alert('请上传 JPG, PNG 或 WebP 格式的图片');
        return;
      }
      if (file.size > 10 * 1024 * 1024) {
        alert('图片大小不能超过 10MB');
        return;
      }
      const fileName = `cell-${x}-${y}`;
      await supabase.storage.from('images').remove([fileName]);
      const { error } = await supabase.storage.from('images').upload(fileName, file, { upsert: true });
      if (error) {
        alert('上传失败: ' + error.message);
        return;
      }
      const { data } = supabase.storage.from('images').getPublicUrl(fileName);
      const publicURL = data.publicUrl;
      const img = document.getElementById(`img-${x}-${y}`);
      img.src = publicURL;
      img.classList.remove('hidden');
      document.getElementById(`upload-icon-${x}-${y}`).classList.add('hidden');
      showNotification('图片上传成功', 'success');
    }

    // 自动加载所有格子的图片（只加载已存在的图片）
    async function loadAllCellImages() {
      // 只加载已存在的图片，避免大量404
      const { data, error } = await supabase.storage.from('images').list('', { limit: 4096 });
      if (error || !data) return;
      data.forEach(image => {
        const match = image.name.match(/^cell-(\d+)-(\d+)$/);
        if (match) {
          const x = parseInt(match[1], 10);
          const y = parseInt(match[2], 10);
          const { data } = supabase.storage.from('images').getPublicUrl(image.name);
          const publicURL = data.publicUrl;
          const img = document.getElementById(`img-${x}-${y}`);
          if (img) {
            img.src = publicURL;
            img.classList.remove('hidden');
            const icon = document.getElementById(`upload-icon-${x}-${y}`);
            if (icon) icon.classList.add('hidden');
          }
        }
      });
    }

    // 初始化渲染
    document.addEventListener('DOMContentLoaded', renderGrid);

    // 图片预览模态框
    const imageModal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const modalFilename = document.getElementById('modal-filename');
    const modalCreatedAt = document.getElementById('modal-created-at');
    const closeModal = document.getElementById('close-modal');
    function openImageModal(filename, url, createdAt) {
      modalImage.src = url;
      modalFilename.textContent = filename;
      modalCreatedAt.textContent = formatDate(createdAt);
      imageModal.classList.remove('hidden');
    }
    closeModal.addEventListener('click', () => {
      imageModal.classList.add('hidden');
    });
    imageModal.addEventListener('click', (e) => {
      if (e.target === imageModal) {
        imageModal.classList.add('hidden');
      }
    });

    // 通用工具
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });
    }
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
      }`;
      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fa fa-${
            type === 'success' ? 'check-circle' : 
            type === 'error' ? 'exclamation-circle' : 
            'info-circle'
          } mr-2"></i>
          <span>${message}</span>
        </div>
      `;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 10);
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }
  </script>
</body>
</html>
